<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½—æ©èŠå¤©å®¤ - æ»¡è¡€å¢å¼ºç‰ˆ</title>
    <style>
        :root { --primary: #007bff; --bg: #f0f2f5; --peer-bg: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; justify-content: center; height: 100vh; margin: 0; padding: 0; }
        
        .container { background: white; width: 100%; max-width: 500px; height: 95vh; margin: auto; display: flex; flex-direction: column; border-radius: 20px; box-shadow: 0 12px 40px rgba(0,0,0,0.12); overflow: hidden; }
        
        /* é¡¶éƒ¨ Header */
        .header { background: #fff; padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        #room-title { color: #333; font-size: 16px; font-weight: bold; }
        #user-count-tag { background: #e1f5fe; color: #039be5; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        #my-name-tag { font-size: 12px; color: #666; margin-top: 4px; line-height: 1.4; }

        /* èŠå¤©åŒº */
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; background: #f7f9fb; display: flex; flex-direction: column; gap: 18px; }

        /* æ°”æ³¡ç¾åŒ– */
        .msg { max-width: 85%; display: flex; flex-direction: column; }
        .msg.me { align-self: flex-end; }
        .msg.peer { align-self: flex-start; }
        .msg-info { font-size: 11px; margin-bottom: 4px; padding: 0 5px; font-weight: bold; }
        .msg-content { padding: 10px 16px; border-radius: 18px; font-size: 14px; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .me .msg-content { background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .peer .msg-content { background: var(--peer-bg); color: #333; border-bottom-left-radius: 2px; }

        /* è¾“å…¥åŒº */
        .input-area { padding: 15px; background: #fff; border-top: 1px solid #eee; display: flex; gap: 10px; }
        #msg-input { flex: 1; padding: 12px 20px; border-radius: 25px; border: 1px solid #eee; outline: none; background: #f1f3f5; font-size: 14px; }
        #send-btn { background: var(--primary); color: white; border: none; padding: 0 22px; border-radius: 25px; font-weight: bold; cursor: pointer; }
    </style>

    <script src="agora-rtm-sdk.js"></script>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <span style="color: #999; font-size: 11px; display: block;">å½“å‰æˆ¿é—´</span>
            <b id="room-title">åŠ è½½ä¸­...</b>
        </div>
        <div style="text-align: right;">
            <span id="user-count-tag">åœ¨çº¿ 1 äºº</span>
            <div id="my-name-tag"></div>
        </div>
    </div>

    <div id="chat-box"></div>

    <div class="input-area">
        <input type="text" id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.keyCode==13) sendMsg()">
        <button id="send-btn" onclick="sendMsg()">å‘é€</button>
    </div>
</div>

<script>
// ======= é…ç½®ä¸çŠ¶æ€ =======
const APP_ID = "2031a372367f433580384793ed09d9bc"; 
const urlParams = new URLSearchParams(window.location.search);

// æ ¸å¿ƒä¿®å¤ç‚¹ 1ï¼šè·å–åŸå§‹ä¸­æ–‡æˆ¿é—´åç”¨äºå±•ç¤º
const DISPLAY_ROOM_NAME = urlParams.get('room') || "Eighth World War Rally"; 

// æ ¸å¿ƒä¿®å¤ç‚¹ 2ï¼šå°†ä¸­æ–‡è½¬æ¢ä¸º SDK æ”¯æŒçš„å­—ç¬¦ï¼ˆä½¿ç”¨ Base64 ç¼–ç ä½œä¸ºåå°é¢‘é“åï¼‰
// btoa ä¸æ”¯æŒ Unicodeï¼Œæ‰€ä»¥å…ˆè¿›è¡Œ URI ç¼–ç è½¬æ¢
const SAFE_CHANNEL_NAME = btoa(encodeURIComponent(DISPLAY_ROOM_NAME)).replace(/[/+=]/g, "");

const MY_UNIQUE_ID = "ID_" + Math.floor(Math.random() * 1000000);
const MY_NAME = prompt("è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼š") || "åŒ¿åç”¨æˆ·";

const COLORS = ['#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#009688', '#ff9800', '#795548', '#607d8b'];
const MY_COLOR = COLORS[Math.floor(Math.random() * COLORS.length)];

let onlineUsers = {}; 
onlineUsers[MY_UNIQUE_ID] = { name: MY_NAME, color: MY_COLOR, lastSeen: Date.now() };

let rtm;

// ======= æ¸²æŸ“å‡½æ•° (ä¼˜å…ˆå®šä¹‰ï¼Œé˜²æ­¢æŠ¥é”™) =======

function appendSysMsg(text) {
    const box = document.getElementById('chat-box');
    const div = document.createElement('div');
    div.style.textAlign = "center";
    div.style.margin = "10px 0";
    div.innerHTML = `<span style="font-size: 11px; color: #bbb; background: rgba(0,0,0,0.05); padding: 2px 12px; border-radius: 20px;">${text}</span>`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

async function sendMsg() {
    const input = document.getElementById('msg-input');
    const content = input.value.trim();
    if (!content) return;

    const msgPayload = {
        uid: MY_UNIQUE_ID,
        name: MY_NAME,
        color: MY_COLOR,
        content: content,
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    };

    try {
        await rtm.publish(SAFE_CHANNEL_NAME, JSON.stringify(msgPayload));
        input.value = "";
    } catch (err) {
        appendSysMsg("âš ï¸ å‘é€å¤±è´¥");
    }
}

function updatePresenceUI() {
    const users = Object.values(onlineUsers);
    document.getElementById('user-count-tag').innerText = `åœ¨çº¿ ${users.length} äºº`;
    
    const nameList = users.map(u => `<span style="color:${u.color}">${u.name}</span>`).join('ã€');
    document.getElementById('my-name-tag').innerHTML = `åœ¨çº¿ï¼š${nameList}`;
}

// ======= æ ¸å¿ƒé€»è¾‘ =======

async function sendNotice(type) {
    try {
        const notice = { type: type, uid: MY_UNIQUE_ID, name: MY_NAME, color: MY_COLOR };
        await rtm.publish(SAFE_CHANNEL_NAME, JSON.stringify(notice));
    } catch(e) { console.error("é€šçŸ¥å‘é€å¤±è´¥", e); }
}

async function init() {
    // ç•Œé¢å±•ç¤ºï¼šä¾ç„¶æ˜¾ç¤ºä¸­æ–‡
    document.getElementById('room-title').innerText = DISPLAY_ROOM_NAME;
  
    try {
        rtm = new AgoraRTM.RTM(APP_ID, MY_UNIQUE_ID, { region: 'NA' }); 
        rtm.addEventListener("message", (event) => {
            const data = JSON.parse(event.message);
            
            if (data.type === 'JOIN_NOTICE' || data.type === 'SYNC_NOTICE') {
                const isKnown = !!onlineUsers[data.uid];
                onlineUsers[data.uid] = { name: data.name, color: data.color, lastSeen: Date.now() };
                
                if (!isKnown && data.type === 'JOIN_NOTICE' && data.uid !== MY_UNIQUE_ID) {
                    appendSysMsg(`ğŸ‘‹ ${data.name} è¿›å…¥äº†èŠå¤©å®¤`);
                }
                updatePresenceUI();

                if (data.type === 'JOIN_NOTICE' && data.uid !== MY_UNIQUE_ID) {
                    sendNotice('SYNC_NOTICE'); 
                }
                return;
            }

            if (data.type === 'LEAVE_NOTICE') {
                if (onlineUsers[data.uid]) {
                    const name = onlineUsers[data.uid].name;
                    delete onlineUsers[data.uid];
                    appendSysMsg(`ğŸƒ ${name} ç¦»å¼€äº†èŠå¤©å®¤`);
                    updatePresenceUI();
                }
                return;
            }

            appendMsg(data, data.uid === MY_UNIQUE_ID ? 'me' : 'peer');
        });

        await rtm.login();
        await rtm.subscribe(SAFE_CHANNEL_NAME);
        window.current_channel = SAFE_CHANNEL_NAME;
        
        sendNotice('JOIN_NOTICE');
        updatePresenceUI();

        window.addEventListener('beforeunload', () => sendNotice('LEAVE_NOTICE'));

        setInterval(() => {
            const now = Date.now();
            let changed = false;
            for (let uid in onlineUsers) {
                if (uid !== MY_UNIQUE_ID && now - onlineUsers[uid].lastSeen > 35000) {
                    delete onlineUsers[uid];
                    changed = true;
                }
            }
            if (changed) updatePresenceUI();
        }, 10000);

    } catch (err) {
        appendSysMsg("âŒ è¿æ¥å¼‚å¸¸");
    }
}

async function sendMsg() {
    const input = document.getElementById('msg-input');
    const content = input.value.trim();
    if (!content) return;

    const msgPayload = {
        uid: MY_UNIQUE_ID,
        name: MY_NAME,
        color: MY_COLOR,
        content: content,
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
    };

    await rtm.publish(CHANNEL_NAME, JSON.stringify(msgPayload));
    input.value = "";
}

init();
</script>   
</body>
</html>

