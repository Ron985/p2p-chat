<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P 极简聊天 - PeerJS 版</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .container { background: white; width: 100%; max-width: 400px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .id-section { background: #e7f3ff; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        #my-id { font-weight: bold; color: #007bff; word-break: break-all; }
        #chat-box { height: 300px; border: 1px solid #ddd; border-radius: 8px; overflow-y: auto; padding: 10px; margin-bottom: 10px; display: flex; flex-direction: column; }
        .msg { margin: 5px 0; padding: 8px 12px; border-radius: 15px; max-width: 80%; font-size: 14px; }
        .msg.me { background: #007bff; color: white; align-self: flex-end; }
        .msg.peer { background: #e4e6eb; color: black; align-self: flex-start; }
        .controls { display: flex; gap: 5px; }
        input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        button { padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>

<div class="container">
    <h3>P2P 临时聊</h3>
    
    <div class="id-section">
        我的 ID: <span id="my-id">正在获取...</span>
    </div>

    <div class="controls" style="margin-bottom: 15px;">
        <input type="text" id="peer-id-input" placeholder="输入好友的 ID">
        <button onclick="connectToPeer()">连接好友</button>
    </div>

    <div id="chat-box"></div>

    <div class="controls">
        <input type="text" id="message-input" placeholder="输入消息..." onkeypress="if(event.keyCode==13) sendMsg()">
        <button id="send-btn" onclick="sendMsg()" disabled>发送</button>
    </div>
</div>

<script>
    let peer;
    let conn;
    const myIdDisplay = document.getElementById('my-id');
    const chatBox = document.getElementById('chat-box');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    // 1. 初始化 Peer 对象 (连接到 PeerJS 官方免费信令服务器)
    peer = new Peer();

    // 当分配到自己的 ID 时
    peer.on('open', (id) => {
        myIdDisplay.innerText = id;
    });

    // 2. 监听他人的连接请求
    peer.on('connection', (c) => {
        conn = c;
        setupConnection();
        appendLog('系统', '好友已连入');
    });

    // 3. 主动连接他人
    function connectToPeer() {
        const peerId = document.getElementById('peer-id-input').value;
        if (!peerId) return alert("请输入 ID");
        
        conn = peer.connect(peerId);
        setupConnection();
        appendLog('系统', '正在连接...');
    }

    // 设置连接监听逻辑
    function setupConnection() {
        conn.on('open', () => {
            sendBtn.disabled = false;
            appendLog('系统', '连接成功，开始聊天吧！');
        });

        conn.on('data', (data) => {
            appendLog('好友', data);
        });

        conn.on('close', () => {
            appendLog('系统', '连接已断开');
            sendBtn.disabled = true;
        });
    }

    // 发送消息
    function sendMsg() {
        const msg = messageInput.value;
        if (!msg || !conn) return;

        conn.send(msg);
        appendLog('我', msg);
        messageInput.value = '';
    }

    // 渲染消息到界面
    function appendLog(sender, text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg ${sender === '我' ? 'me' : (sender === '好友' ? 'peer' : '')}`;
        msgDiv.innerText = (sender === '系统' ? '' : sender + ': ') + text;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>