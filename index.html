<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç½—æ©èŠå¤©å®¤ - å®Œç¾ç²¾ä¿®ç‰ˆ</title>
    <style>
        :root { --primary: #007bff; --bg: #f0f2f5; --vh: 1vh; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; height: calc(var(--vh) * 100); display: flex; flex-direction: column; overflow: hidden; }
        .container { background: white; width: 100%; max-width: 600px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; }
        
        /* é¡¶éƒ¨ Header ä¼˜åŒ–ï¼šç›´æ¥æ˜¾ç¤ºåˆ—è¡¨ */
        .header { padding: 12px 15px; border-bottom: 1px solid #eee; background: #fff; z-index: 100; }
        .header-main { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        #room-title { font-size: 16px; font-weight: bold; color: #333; }
        .status-tag { background: #e1f5fe; color: #039be5; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        #user-list-text { font-size: 12px; color: #888; line-height: 1.4; border-top: 1px dashed #eee; padding-top: 5px; }

        #chat-box { flex: 1; overflow-y: auto; padding: 15px; background: #f8f9fa; display: flex; flex-direction: column; gap: 12px; -webkit-overflow-scrolling: touch; }
        .msg { max-width: 85%; display: flex; flex-direction: column; }
        .msg.me { align-self: flex-end; }
        .msg.peer { align-self: flex-start; }
        .msg-info { font-size: 11px; margin-bottom: 2px; font-weight: bold; }
        .msg-content { padding: 8px 14px; border-radius: 15px; font-size: 15px; word-break: break-all; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .me .msg-content { background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .peer .msg-content { background: #fff; color: #333; border-bottom-left-radius: 2px; }

        .input-area { padding: 10px 15px calc(10px + env(safe-area-inset-bottom)); background: #fff; border-top: 1px solid #eee; display: flex; gap: 10px; }
        #msg-input { flex: 1; height: 40px; padding: 0 15px; border-radius: 20px; border: 1px solid #ddd; background: #f1f3f5; font-size: 16px; outline: none; }
        #send-btn { background: var(--primary); color: white; border: none; padding: 0 18px; border-radius: 20px; font-weight: bold; }
    </style>
    <script src="agora-rtm-sdk.js"></script>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-main">
            <div>
                <span id="room-title">è¿æ¥ä¸­...</span>
                <span style="font-size: 12px; color: #999; margin-left:5px;">(æˆ‘: <b id="my-name-val"></b>)</span>
            </div>
            <span class="status-tag" id="user-count-tag">åœ¨çº¿ 1 äºº</span>
        </div>
        <div id="user-list-text">åœ¨çº¿æˆå‘˜åŠ è½½ä¸­...</div>
    </div>
    <div id="chat-box"></div>
    <div class="input-area">
        <input type="text" id="msg-input" placeholder="å‘æ¶ˆæ¯..." enterkeyhint="send">
        <button id="send-btn" onclick="sendMsg()">å‘é€</button>
    </div>
</div>

<script>
const APP_ID = "2031a372367f433580384793ed09d9bc"; 
const urlParams = new URLSearchParams(window.location.search);
const DISPLAY_ROOM_NAME = urlParams.get('room') || "é»˜è®¤æˆ¿é—´";
const MY_UNIQUE_ID = "ID_" + Math.floor(Math.random() * 1000000);
const MY_NAME = prompt("ä½ çš„æ˜µç§°ï¼š") || "åŒ¿å";
const MY_COLOR = ['#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#009688'][Math.floor(Math.random() * 5)];

let rtm, SAFE_CHANNEL_NAME;
let onlineUsers = {}; 
onlineUsers[MY_UNIQUE_ID] = { name: MY_NAME, color: MY_COLOR, lastSeen: Date.now() };

async function getSafeName(name) {
    const msgUint8 = new TextEncoder().encode(name);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
    return "r_" + Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 30);
}

function updateUI() {
    const users = Object.values(onlineUsers);
    document.getElementById('user-count-tag').innerText = `åœ¨çº¿ ${users.length} äºº`;
    document.getElementById('my-name-val').innerText = MY_NAME;
    document.getElementById('my-name-val').style.color = MY_COLOR;
    document.getElementById('user-list-text').innerHTML = "åœ¨çº¿ï¼š" + users.map(u => 
        `<span style="color:${u.color}">${u.uid === MY_UNIQUE_ID ? '<b>(æˆ‘)</b>' : u.name}</span>`
    ).join('ã€');
}

async function init() {
    if (typeof AgoraRTM === 'undefined') { setTimeout(init, 500); return; }
    document.getElementById('room-title').innerText = DISPLAY_ROOM_NAME;
    SAFE_CHANNEL_NAME = await getSafeName(DISPLAY_ROOM_NAME);
    try {
        rtm = new AgoraRTM.RTM(APP_ID, MY_UNIQUE_ID, { region: 'NA' });
        rtm.addEventListener("message", (event) => {
            const data = JSON.parse(event.message);
            
            // æ”¶åˆ°åŠ å…¥é€šçŸ¥ï¼ˆæ–°äººè¿›åœºï¼‰
            if (data.type === 'JOIN') {
                const isFirstTimeKnown = !onlineUsers[data.uid];
                onlineUsers[data.uid] = { name: data.name, color: data.color, lastSeen: Date.now() };
                updateUI();
                // æ ¸å¿ƒä¿®å¤ï¼šåªæœ‰ã€è€ç”¨æˆ·ã€‘çœ‹åˆ°ã€æ–°äººã€‘æ‰å¼¹é€šçŸ¥ã€‚æ–°äººè‡ªå·±ä¸çœ‹ã€‚
                if (isFirstTimeKnown && data.uid !== MY_UNIQUE_ID) {
                    appendSysMsg(`ğŸ‘‹ ${data.name} è¿›å…¥äº†èŠå¤©å®¤`);
                    sendNotice('SYNC'); // æˆ‘æ˜¯è€ç”¨æˆ·ï¼Œæˆ‘å‘Šè¯‰æ–°äººæˆ‘è¿˜åœ¨ï¼Œä½†è¿™ä¸è§¦å‘é€šçŸ¥
                }
            } 
            // æ”¶åˆ°åŒæ­¥é€šçŸ¥ï¼ˆè€ç”¨æˆ·å›åº”æ–°äººï¼‰
            else if (data.type === 'SYNC') {
                onlineUsers[data.uid] = { name: data.name, color: data.color, lastSeen: Date.now() };
                updateUI();
                // æ³¨æ„ï¼šè¿™é‡Œä¸å†™ appendSysMsgï¼Œæ‰€ä»¥æ–°äººè¿›åœºæ—¶ä¸ä¼šè¢«åˆ·å±
            }
            // æ”¶åˆ°ç¦»å¼€é€šçŸ¥
            else if (data.type === 'LEAVE') {
                if(onlineUsers[data.uid]) {
                    appendSysMsg(`ğŸƒ ${onlineUsers[data.uid].name} ç¦»å¼€äº†èŠå¤©å®¤`);
                    delete onlineUsers[data.uid];
                    updateUI();
                }
            }
            // æ™®é€šèŠå¤©æ¶ˆæ¯
            else if (data.content) {
                onlineUsers[data.uid] = { ...onlineUsers[data.uid], lastSeen: Date.now() }; // æ”¶åˆ°æ¶ˆæ¯ä¹Ÿè§†ä¸ºæ´»è·ƒ
                renderMsg(data);
            }
        });

        await rtm.login();
        await rtm.subscribe(SAFE_CHANNEL_NAME);
        sendNotice('JOIN');
        updateUI();

        // ç¦»çº¿æ¸…ç†è®¡æ—¶å™¨ (å¦‚æœ40ç§’æ²¡æ”¶åˆ°ä»»ä½•ä¿¡å·ï¼Œåˆ¤å®šæ‰çº¿å¹¶å¼¹é€šçŸ¥)
        setInterval(() => {
            const now = Date.now();
            for (let uid in onlineUsers) {
                if (uid !== MY_UNIQUE_ID && (now - onlineUsers[uid].lastSeen > 40000)) {
                    appendSysMsg(`ğŸƒ ${onlineUsers[uid].name} æ„å¤–æ‰çº¿äº†`);
                    delete onlineUsers[uid];
                    updateUI();
                }
            }
        }, 10000);
    } catch (e) { console.error(e); }
}

async function sendNotice(type) {
    if(!rtm) return;
    rtm.publish(SAFE_CHANNEL_NAME, JSON.stringify({ type, uid: MY_UNIQUE_ID, name: MY_NAME, color: MY_COLOR })).catch(()=>{});
}

function renderMsg(data) {
    const box = document.getElementById('chat-box');
    const side = data.uid === MY_UNIQUE_ID ? 'me' : 'peer';
    const div = document.createElement('div');
    div.className = `msg ${side}`;
    div.innerHTML = `<div class="msg-info" style="color:${data.color}; align-self:${side==='me'?'flex-end':'flex-start'}">${data.name}</div><div class="msg-content">${data.content}</div>`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

async function sendMsg() {
    const input = document.getElementById('msg-input');
    const content = input.value.trim();
    if (!content || !rtm) return;
    await rtm.publish(SAFE_CHANNEL_NAME, JSON.stringify({ uid: MY_UNIQUE_ID, name: MY_NAME, color: MY_COLOR, content: content }));
    input.value = "";
}

function appendSysMsg(text) {
    const div = document.createElement('div');
    div.style = "text-align:center; margin:8px 0; font-size:11px; color:#bbb;";
    div.innerHTML = `<span style="background:rgba(0,0,0,0.03); padding:2px 10px; border-radius:10px;">${text}</span>`;
    document.getElementById('chat-box').appendChild(div);
    document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
}

function fixVh() { document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); }
window.addEventListener('resize', fixVh);
fixVh();
document.getElementById('msg-input').addEventListener('keypress', e => { if(e.key==='Enter') sendMsg(); });
window.addEventListener('beforeunload', () => sendNotice('LEAVE'));
init();
</script>
</body>
</html>
