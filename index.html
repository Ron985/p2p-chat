<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç½—æ©èŠå¤©å®¤</title>
    <style>
        :root {
            --primary: #007bff;
            --bg: #f0f2f5;
            /* è§£å†³ç§»åŠ¨ç«¯ 100vh åŒ…å«å·¥å…·æ çš„é—®é¢˜ */
            --vh: 1vh;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg);
            margin: 0;
            /* åŠ¨æ€é«˜åº¦ï¼Œé˜²æ­¢é”®ç›˜å¼¹å‡ºå¯¼è‡´å¸ƒå±€æ··ä¹± */
            height: calc(var(--vh) * 100);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* é˜²æ­¢bodyæ»šåŠ¨ï¼Œè®©å†…éƒ¨ç›’å­æ»šåŠ¨ */
        }

        .container {
            background: white;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* é¡¶éƒ¨ Headerï¼šæ›´ç´§å‡‘ï¼Œé€‚åˆç§»åŠ¨ç«¯ */
        .header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        #room-title {
            font-size: 15px;
            color: #333;
        }

        #user-count-tag {
            font-size: 10px;
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* èŠå¤©åŒºï¼šè‡ªåŠ¨ä¼¸ç¼© */
        #chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 12px;
            /* å…è®¸å¹³æ»‘æ»šåŠ¨ */
            -webkit-overflow-scrolling: touch;
        }

        /* æ°”æ³¡ä¼˜åŒ–ï¼šé€‚é…çª„å± */
        .msg {
            max-width: 90%;
        }

        .msg-content {
            padding: 8px 14px;
            border-radius: 15px;
            font-size: 15px;
            /* å­—ä½“ä¸èƒ½å°äº16pxï¼Œå¦åˆ™iOSä¼šè‡ªåŠ¨æ”¾å¤§é¡µé¢ï¼Œè¿™é‡Œç”¨15.5æˆ–16è¾ƒå¥½ */
            word-wrap: break-word;
        }

        /* åº•éƒ¨è¾“å…¥åŒºï¼šå›ºå®šåœ¨åº•éƒ¨ï¼Œé¿å¼€ç³»ç»Ÿæ‰‹åŠ¿åŒº */
        .input-area {
            padding: 10px 15px calc(10px + env(safe-area-inset-bottom));
            background: #fff;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #msg-input {
            flex: 1;
            height: 40px;
            padding: 0 15px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: #f1f3f5;
            font-size: 16px;
            /* è§£å†³ iOS ç‚¹å‡»æ”¾å¤§é—®é¢˜ */
            outline: none;
        }

        #send-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 60px;
            height: 40px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
        }

        /* ç³»ç»Ÿæ¶ˆæ¯ */
        .sys-msg {
            text-align: center;
            font-size: 12px;
            color: #bbb;
            margin: 5px 0;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header">
            <div>
                <b id="room-title">åŠ è½½ä¸­...</b>
                <div id="my-name-tag" style="font-size: 10px; color: #999;"></div>
            </div>
            <span id="user-count-tag">åœ¨çº¿ 1 äºº</span>
        </div>

        <div id="chat-box"></div>

        <div class="input-area">
            <input type="text" id="msg-input" placeholder="å‘æ¶ˆæ¯..." enterkeyhint="send">
            <button id="send-btn" onclick="sendMsg()">å‘é€</button>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒä¼˜åŒ– 1ï¼šè§£å†³ç§»åŠ¨ç«¯ 100vh åŠ¨æ€é«˜åº¦é—®é¢˜
        function resetHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        window.addEventListener('resize', resetHeight);
        window.addEventListener('orientationchange', resetHeight);
        resetHeight();

        // æ ¸å¿ƒä¼˜åŒ– 2ï¼šè§£å†³é”®ç›˜å¼¹èµ·é®æŒ¡é—®é¢˜
        const msgInput = document.getElementById('msg-input');
        msgInput.addEventListener('focus', () => {
            // å»¶è¿Ÿæ»šåŠ¨ï¼Œç­‰å¾…é”®ç›˜å®Œå…¨å¼¹èµ·
            setTimeout(() => {
                document.getElementById('chat-box').scrollTop = document.getElementById('chat-box')
                    .scrollHeight;
            }, 300);
        });
        // ======= é…ç½®ä¸çŠ¶æ€ =======
        const APP_ID = "2031a372367f433580384793ed09d9bc";
        const urlParams = new URLSearchParams(window.location.search);

        // ======= æ ¸å¿ƒä¿®å¤ï¼šSHA-256 å›ºå®šé•¿åº¦å“ˆå¸Œç®—æ³• =======
        const DISPLAY_ROOM_NAME = urlParams.get('room') || "é»˜è®¤æˆ¿é—´";

        // è¿™æ˜¯ä¸€ä¸ªæå…¶ç²¾ç®€çš„å“ˆå¸Œç®—æ³•ï¼Œå°†ä»»æ„ä¸­æ–‡è½¬æ¢ä¸ºå›ºå®šé•¿åº¦çš„åˆæ³•è‹±æ–‡æ•°å­—å­—ç¬¦ä¸²
        async function hashRoomName(name) {
            const msgUint8 = new TextEncoder().encode(name);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 32);
        }

        // å› ä¸ºå“ˆå¸Œæ˜¯å¼‚æ­¥çš„ï¼Œæˆ‘ä»¬éœ€è¦å¾®è°ƒåˆå§‹åŒ–é€»è¾‘
        let SAFE_CHANNEL_NAME = "";

        const MY_UNIQUE_ID = "ID_" + Math.floor(Math.random() * 1000000);
        const MY_NAME = prompt("è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼š") || "ç¥ç§˜äºº";
        const COLORS = ['#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#009688', '#ff9800', '#795548', '#607d8b'];
        const MY_COLOR = COLORS[Math.floor(Math.random() * COLORS.length)];

        let onlineUsers = {};
        onlineUsers[MY_UNIQUE_ID] = {
            name: MY_NAME,
            color: MY_COLOR,
            lastSeen: Date.now()
        };

        let rtm;

        // ======= å·¥å…·å‡½æ•° =======

        function appendSysMsg(text) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.style.textAlign = "center";
            div.style.margin = "10px 0";
            div.innerHTML =
                `<span style="font-size: 11px; color: #bbb; background: rgba(0,0,0,0.05); padding: 2px 12px; border-radius: 20px;">${text}</span>`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function appendMsg(data, side) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `msg ${side}`;
            div.innerHTML = `
        <div class="msg-info" style="color: ${data.color}; text-align: ${side==='me'?'right':'left'}">
            ${data.name} <span style="color: #ccc; font-weight: normal;">${data.time}</span>
        </div>
        <div class="msg-content">${data.content}</div>
    `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function updatePresenceUI() {
            const users = Object.values(onlineUsers);
            document.getElementById('user-count-tag').innerText = `åœ¨çº¿ ${users.length} äºº`;
            const nameList = users.map(u => `<span style="color:${u.color}">${u.name}</span>`).join('ã€');
            document.getElementById('my-name-tag').innerHTML = `åœ¨çº¿ï¼š${nameList}`;
        }


        // ======= åˆå§‹åŒ–ä¸æ ¸å¿ƒé€»è¾‘ =======
        async function init() {
            document.getElementById('room-title').innerText = DISPLAY_ROOM_NAME;

            // 1. å…ˆç”Ÿæˆåˆæ³•çš„æˆ¿é—´ ID
            SAFE_CHANNEL_NAME = "r_" + await hashRoomName(DISPLAY_ROOM_NAME);
            console.log("åŠ å¯†åçš„å®‰å…¨é¢‘é“å:", SAFE_CHANNEL_NAME);

            try {
                rtm = new AgoraRTM.RTM(APP_ID, MY_UNIQUE_ID, {
                    region: 'NA'
                });

                rtm.addEventListener("message", (event) => {
                    const data = JSON.parse(event.message);

                    if (data.type === 'JOIN_NOTICE' || data.type === 'SYNC_NOTICE') {
                        const isKnown = !!onlineUsers[data.uid];
                        onlineUsers[data.uid] = {
                            name: data.name,
                            color: data.color,
                            lastSeen: Date.now()
                        };
                        if (!isKnown && data.type === 'JOIN_NOTICE' && data.uid !== MY_UNIQUE_ID) {
                            appendSysMsg(`ğŸ‘‹ ${data.name} è¿›å…¥äº†èŠå¤©å®¤`);
                        }
                        updatePresenceUI();
                        if (data.type === 'JOIN_NOTICE' && data.uid !== MY_UNIQUE_ID) sendNotice(
                            'SYNC_NOTICE');
                        return;
                    }

                    if (data.type === 'LEAVE_NOTICE') {
                        if (onlineUsers[data.uid]) {
                            const name = onlineUsers[data.uid].name;
                            delete onlineUsers[data.uid];
                            appendSysMsg(`ğŸƒ ${name} ç¦»å¼€äº†èŠå¤©å®¤`);
                            updatePresenceUI();
                        }
                        return;
                    }

                    appendMsg(data, data.uid === MY_UNIQUE_ID ? 'me' : 'peer');
                });

                await rtm.login();

                // 2. ä½¿ç”¨ç”Ÿæˆçš„å›ºå®šé•¿åº¦ ID è®¢é˜…
                await rtm.subscribe(SAFE_CHANNEL_NAME);

                sendNotice('JOIN_NOTICE');
                updatePresenceUI();

                window.addEventListener('beforeunload', () => sendNotice('LEAVE_NOTICE'));

                setInterval(() => {
                    const now = Date.now();
                    let changed = false;
                    for (let uid in onlineUsers) {
                        if (uid !== MY_UNIQUE_ID && now - onlineUsers[uid].lastSeen > 35000) {
                            delete onlineUsers[uid];
                            changed = true;
                        }
                    }
                    if (changed) updatePresenceUI();
                }, 10000);

            } catch (err) {
                console.error("åˆå§‹åŒ–å¤±è´¥:", err);
                appendSysMsg("âŒ è¿æ¥å¤±è´¥ï¼šé¢‘é“åè½¬æ¢é”™è¯¯");
            }
        }

        // å‘é€å‡½æ•°ä¿æŒä¸å˜ï¼Œå®ƒä»¬ä¼šè‡ªåŠ¨ä½¿ç”¨ä¸Šé¢ç”Ÿæˆçš„ SAFE_CHANNEL_NAME
        async function sendNotice(type) {
            if (!SAFE_CHANNEL_NAME) return;
            try {
                const notice = {
                    type: type,
                    uid: MY_UNIQUE_ID,
                    name: MY_NAME,
                    color: MY_COLOR
                };
                await rtm.publish(SAFE_CHANNEL_NAME, JSON.stringify(notice));
            } catch (e) {}
        }

        async function sendMsg() {
            const input = document.getElementById('msg-input');
            const content = input.value.trim();
            if (!content || !SAFE_CHANNEL_NAME) return;

            const msgPayload = {
                uid: MY_UNIQUE_ID,
                name: MY_NAME,
                color: MY_COLOR,
                content: content,
                time: new Date().toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit'
                })
            };

            try {
                await rtm.publish(SAFE_CHANNEL_NAME, JSON.stringify(msgPayload));
                input.value = "";
            } catch (err) {
                appendSysMsg("âš ï¸ å‘é€å¤±è´¥");
            }
        }

        init();
    </script>
</body>

</html>
