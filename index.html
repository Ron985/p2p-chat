<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç½—æ©èŠå¤©å®¤ - æœ€ç»ˆä¿®å¤ç‰ˆ</title>
    <style>
        :root { --primary: #007bff; --bg: #f0f2f5; --vh: 1vh; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; 
            height: calc(var(--vh) * 100); display: flex; flex-direction: column; overflow: hidden; 
        }
        .container { background: white; width: 100%; max-width: 600px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; }
        .header { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; z-index: 10; }
        #room-title { font-size: 16px; font-weight: bold; color: #333; }
        #user-count-tag { background: #e1f5fe; color: #039be5; padding: 2px 8px; border-radius: 10px; font-size: 11px; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; background: #f8f9fa; display: flex; flex-direction: column; gap: 12px; -webkit-overflow-scrolling: touch; }
        .msg { max-width: 85%; display: flex; flex-direction: column; }
        .msg.me { align-self: flex-end; }
        .msg.peer { align-self: flex-start; }
        .msg-info { font-size: 11px; margin-bottom: 4px; font-weight: bold; }
        .msg-content { padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; word-break: break-all; }
        .me .msg-content { background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .peer .msg-content { background: #fff; color: #333; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .input-area { padding: 10px 15px calc(10px + env(safe-area-inset-bottom)); background: #fff; border-top: 1px solid #eee; display: flex; gap: 10px; }
        #msg-input { flex: 1; height: 42px; padding: 0 15px; border-radius: 21px; border: 1px solid #ddd; background: #f1f3f5; font-size: 16px; outline: none; }
        #send-btn { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 21px; font-weight: bold; }
    </style>
    <script src="agora-rtm-sdk.js"></script>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <span id="room-title">æ­£åœ¨è¿æ¥...</span>
            <div id="my-name-tag" style="font-size: 10px; color: #999; margin-top:2px;"></div>
        </div>
        <span id="user-count-tag">åœ¨çº¿ 1 äºº</span>
    </div>
    <div id="chat-box"></div>
    <div class="input-area">
        <input type="text" id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯..." enterkeyhint="send">
        <button id="send-btn" onclick="sendMsg()">å‘é€</button>
    </div>
</div>

<script>
// ======= é…ç½®ä¸å“ˆå¸Œç®—æ³• =======
const APP_ID = "2031a372367f433580384793ed09d9bc"; 
const urlParams = new URLSearchParams(window.location.search);
const DISPLAY_ROOM_NAME = urlParams.get('room') || "é»˜è®¤æˆ¿é—´";
const MY_UNIQUE_ID = "ID_" + Math.floor(Math.random() * 1000000);
const MY_NAME = prompt("è¯·è¾“å…¥æ˜µç§°ï¼š") || "ç¥ç§˜äºº";
const MY_COLOR = ['#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#009688'][Math.floor(Math.random() * 5)];

let rtm, SAFE_CHANNEL_NAME;
let onlineUsers = {};
onlineUsers[MY_UNIQUE_ID] = { name: MY_NAME, color: MY_COLOR, lastSeen: Date.now() };

// å“ˆå¸Œå‡½æ•°ï¼šç¡®ä¿æˆ¿é—´ååˆæ³•
async function getSafeName(name) {
    const msgUint8 = new TextEncoder().encode(name);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return "r_" + hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 30);
}

// UI è¾…åŠ©
function appendSysMsg(text) {
    const box = document.getElementById('chat-box');
    const div = document.createElement('div');
    div.style = "text-align:center; margin:10px 0; font-size:11px; color:#bbb;";
    div.innerHTML = `<span style="background:rgba(0,0,0,0.03); padding:2px 10px; border-radius:10px;">${text}</span>`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

function updatePresenceUI() {
    const users = Object.values(onlineUsers);
    document.getElementById('user-count-tag').innerText = `åœ¨çº¿ ${users.length} äºº`;
    document.getElementById('my-name-tag').innerText = `æˆ‘çš„æ˜µç§°ï¼š${MY_NAME}`;
}

// ======= æ ¸å¿ƒé€»è¾‘ =======

async function init() {
    // 2. æ£€æŸ¥ SDK æ˜¯å¦æˆåŠŸåŠ è½½
    if (typeof AgoraRTM === 'undefined') {
        setTimeout(init, 500); // å¦‚æœæ²¡åŠ è½½å¥½ï¼ŒåŠç§’åå†è¯•
        return;
    }

    document.getElementById('room-title').innerText = DISPLAY_ROOM_NAME;
    SAFE_CHANNEL_NAME = await getSafeName(DISPLAY_ROOM_NAME);

    try {
        rtm = new AgoraRTM.RTM(APP_ID, MY_UNIQUE_ID, { region: 'NA' });
        
        rtm.addEventListener("message", (event) => {
            const data = JSON.parse(event.message);
            if (data.type === 'JOIN_NOTICE' || data.type === 'SYNC_NOTICE') {
                const isNew = !onlineUsers[data.uid];
                onlineUsers[data.uid] = { name: data.name, color: data.color, lastSeen: Date.now() };
                updatePresenceUI();
                if (isNew && data.uid !== MY_UNIQUE_ID) {
                    appendSysMsg(`ğŸ‘‹ ${data.name} åŠ å…¥äº†`);
                    sendNotice('SYNC_NOTICE');
                }
            } else if (data.type === 'LEAVE_NOTICE') {
                delete onlineUsers[data.uid];
                updatePresenceUI();
            } else {
                renderMsg(data);
            }
        });

        await rtm.login();
        await rtm.subscribe(SAFE_CHANNEL_NAME);
        sendNotice('JOIN_NOTICE');
        updatePresenceUI();

    } catch (err) {
        appendSysMsg("âŒ è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®");
    }
}

function renderMsg(data) {
    const box = document.getElementById('chat-box');
    const side = data.uid === MY_UNIQUE_ID ? 'me' : 'peer';
    const div = document.createElement('div');
    div.className = `msg ${side}`;
    div.innerHTML = `
        <div class="msg-info" style="color:${data.color}; align-self:${side==='me'?'flex-end':'flex-start'}">${data.name}</div>
        <div class="msg-content">${data.content}</div>
    `;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

async function sendMsg() {
    const input = document.getElementById('msg-input');
    const content = input.value.trim();
    if (!content || !rtm) return;

    const payload = { uid: MY_UNIQUE_ID, name: MY_NAME, color: MY_COLOR, content: content };
    await rtm.publish(SAFE_CHANNEL_NAME, JSON.stringify(payload));
    input.value = "";
}

async function sendNotice(type) {
    if (!rtm) return;
    const notice = { type: type, uid: MY_UNIQUE_ID, name: MY_NAME, color: MY_COLOR };
    rtm.publish(SAFE_CHANNEL_NAME, JSON.stringify(notice)).catch(()=>{});
}

// é€‚é…æ‰‹æœºé«˜åº¦
function fixVh() { document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); }
window.addEventListener('resize', fixVh);
fixVh();

// å›è½¦å‘é€
document.getElementById('msg-input').addEventListener('keypress', e => { if(e.key==='Enter') sendMsg(); });

// å¯åŠ¨
init();
</script>
</body>
</html>
